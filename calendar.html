<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</title>
<style>
  :root {
    --bg:#f5f7fa; --card:#fff; --primary:#4a6cf7; --primary-light:#e8edff;
    --success:#22c55e; --success-light:#dcfce7; --warning:#f59e0b; --warning-light:#fef3c7;
    --danger:#ef4444; --danger-light:#fee2e2; --gray:#6b7280; --gray-light:#f3f4f6;
    --border:#e5e7eb; --text:#1f2937; --text-light:#9ca3af;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}

  .header{background:linear-gradient(135deg,#4a6cf7,#6366f1);color:#fff;padding:20px 32px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
  .header h1{font-size:22px;font-weight:600}
  .tabs{display:flex;gap:4px;background:rgba(255,255,255,.15);border-radius:10px;padding:4px}
  .tab{padding:7px 18px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;color:rgba(255,255,255,.7);border:none;background:none;transition:all .2s}
  .tab:hover{color:#fff;background:rgba(255,255,255,.1)}
  .tab.active{background:#fff;color:var(--primary)}

  .container{max-width:1200px;margin:0 auto;padding:24px}
  .hidden{display:none!important}

  /* Calendar */
  .cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .cal-nav h2{font-size:20px;font-weight:600}
  .btn{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:7px 14px;cursor:pointer;font-size:13px;color:var(--text);transition:all .15s}
  .btn:hover{background:var(--primary-light);color:var(--primary)}
  .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  .btn-primary:hover{background:#3b5de7}
  .btn-danger{background:var(--danger);color:#fff;border-color:var(--danger)}
  .btn-danger:hover{background:#dc2626}
  .btn-sm{padding:4px 10px;font-size:12px}

  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border);border-radius:12px;overflow:hidden;box-shadow:0 1px 3px rgba(0,0,0,.08)}
  .cal-hdr{background:var(--gray-light);padding:10px 4px;text-align:center;font-size:13px;font-weight:600;color:var(--gray)}
  .cal-cell{min-height:90px;padding:5px;background:var(--card);cursor:pointer;transition:background .1s;position:relative}
  .cal-cell:hover{background:#fafbff}
  .cal-cell.other{background:var(--gray-light);opacity:.4}
  .cal-cell.today{box-shadow:inset 0 0 0 2px var(--primary)}
  .cal-day{font-size:12px;font-weight:600;color:var(--gray);margin-bottom:3px}
  .cal-cell.today .cal-day{color:var(--primary)}
  .cal-ev{font-size:10px;padding:1px 5px;border-radius:3px;margin-bottom:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .cal-ev.ind{background:var(--primary-light);color:#3b4fd4;border-left:2px solid var(--primary)}
  .cal-ev.grp{background:var(--warning-light);color:#92400e;border-left:2px solid var(--warning)}
  .cal-ev.ok{border-left-color:var(--success)}
  .cal-ev.no{border-left-color:var(--danger)}
  .cal-more{font-size:10px;color:var(--primary);font-weight:500}

  /* Forms & Modals */
  .overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:100;justify-content:center;align-items:flex-start;padding-top:60px}
  .overlay.open{display:flex}
  .modal{background:var(--card);border-radius:14px;width:90%;max-width:520px;max-height:80vh;overflow-y:auto;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,.2)}
  .modal h3{font-size:17px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center}
  .modal-x{background:none;border:none;font-size:22px;cursor:pointer;color:var(--gray);padding:0 4px}
  .modal-x:hover{color:var(--text)}

  .form-row{margin-bottom:12px}
  .form-row label{display:block;font-size:13px;font-weight:500;margin-bottom:4px;color:var(--gray)}
  .form-row input,.form-row select,.form-row textarea{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit}
  .form-row input:focus,.form-row select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(74,108,247,.15)}
  .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}

  /* Cards */
  .card{background:var(--card);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:12px;overflow:hidden}
  .card-hdr{padding:14px 18px;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
  .card-hdr:hover{background:var(--gray-light)}
  .card-body{padding:0 18px 14px;display:none}
  .card-body.open{display:block}

  .student-name{font-size:15px;font-weight:600}
  .student-info{font-size:12px;color:var(--gray)}
  .badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:500}
  .badge-ok{background:var(--success-light);color:#15803d}
  .badge-no{background:var(--danger-light);color:#b91c1c}
  .badge-gray{background:var(--gray-light);color:var(--gray)}

  .lesson-row{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid var(--border);font-size:13px}
  .lesson-row:last-child{border:none}

  /* Attendance table */
  .att-wrap{overflow-x:auto}
  .att-tbl{width:100%;border-collapse:collapse;font-size:12px}
  .att-tbl th,.att-tbl td{padding:6px 8px;text-align:center;border-bottom:1px solid var(--border)}
  .att-tbl th{background:var(--gray-light);font-weight:600;color:var(--gray);position:sticky;top:0}
  .att-tbl td:first-child,.att-tbl th:first-child{text-align:left;position:sticky;left:0;background:var(--card);z-index:1;min-width:140px;font-weight:500}
  .att-tbl th:first-child{background:var(--gray-light);z-index:2}
  .att-dot{width:22px;height:22px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;user-select:none}
  .att-dot.yes{background:var(--success-light);color:var(--success)}
  .att-dot.no{background:var(--danger-light);color:var(--danger)}

  .section-title{font-size:17px;font-weight:600;margin-bottom:12px}
  .empty{text-align:center;padding:40px;color:var(--text-light);font-size:14px}

  /* Statistics */
  .stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-bottom:20px}
  .stat-card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
  .stat-name{font-size:15px;font-weight:600;margin-bottom:8px}
  .stat-group{font-size:12px;color:var(--gray);margin-bottom:12px}
  .stat-row{display:flex;justify-content:space-between;margin-bottom:6px;font-size:13px}
  .stat-label{color:var(--gray)}
  .stat-value{font-weight:600}
  .stat-value.good{color:var(--success)}
  .stat-value.bad{color:var(--danger)}
  .progress-bar{height:8px;background:var(--gray-light);border-radius:4px;overflow:hidden;margin:8px 0}
  .progress-fill{height:100%;background:linear-gradient(90deg,var(--success),var(--primary));transition:width .3s}
  .percent-big{font-size:28px;font-weight:700;color:var(--primary);margin:8px 0}

  @media(max-width:768px){
    .header{padding:14px}
    .header h1{font-size:17px}
    .container{padding:14px}
    .cal-cell{min-height:60px;padding:3px}
    .cal-ev{font-size:9px}
  }
</style>
</head>
<body>

<div class="header">
  <h1>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</h1>
  <div class="tabs">
    <button class="tab active" onclick="showView('calendar',this)">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</button>
    <button class="tab" onclick="showView('students',this)">–£—á–µ–Ω–∏–∫–∏</button>
    <button class="tab" onclick="showView('schedule',this)">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
    <button class="tab" onclick="showView('attendance',this)">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</button>
    <button class="tab" onclick="showView('stats',this)">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
  </div>
</div>

<div class="container">
  <!-- ========== CALENDAR ========== -->
  <div id="v-calendar">
    <div class="cal-nav">
      <button class="btn" onclick="chgMonth(-1)">&larr;</button>
      <h2 id="month-label"></h2>
      <button class="btn" onclick="chgMonth(1)">&rarr;</button>
    </div>
    <div class="cal-grid" id="cal-grid"></div>
  </div>

  <!-- ========== STUDENTS ========== -->
  <div id="v-students" class="hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div class="section-title">–£—á–µ–Ω–∏–∫–∏</div>
      <button class="btn btn-primary" onclick="openAddStudent()">+ –î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</button>
    </div>
    <div id="students-list"></div>
  </div>

  <!-- ========== SCHEDULE ========== -->
  <div id="v-schedule" class="hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px">
      <div class="section-title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary" onclick="openAddLesson()">+ –î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ</button>
        <button class="btn" onclick="openRecurring()">üîÅ –ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</button>
      </div>
    </div>
    <div id="schedule-list"></div>
  </div>

  <!-- ========== ATTENDANCE ========== -->
  <div id="v-attendance" class="hidden">
    <div class="section-title">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</div>
    <div id="att-content"></div>
  </div>

  <!-- ========== STATISTICS ========== -->
  <div id="v-stats" class="hidden">
    <div class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</div>
    <div id="stats-content"></div>
  </div>
</div>

<!-- ===== Day Detail Modal ===== -->
<div class="overlay" id="m-day" onclick="if(event.target===this)closeAll()">
  <div class="modal">
    <h3><span id="m-day-title"></span><button class="modal-x" onclick="closeAll()">&times;</button></h3>
    <div id="m-day-body"></div>
  </div>
</div>

<!-- ===== Add/Edit Student Modal ===== -->
<div class="overlay" id="m-student" onclick="if(event.target===this)closeAll()">
  <div class="modal">
    <h3><span id="m-student-title">–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</span><button class="modal-x" onclick="closeAll()">&times;</button></h3>
    <div class="form-row"><label>–ò–º—è —É—á–µ–Ω–∏–∫–∞</label><input id="f-sname" placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è"></div>
    <div class="form-row"><label>–ü—Ä–µ–¥–º–µ—Ç—ã / –æ–ø–∏—Å–∞–Ω–∏–µ</label><input id="f-sdesc" placeholder="–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞, —Ä—É—Å—Å–∫–∏–π..."></div>
    <div class="form-row"><label>–ì—Ä—É–ø–ø–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><input id="f-sgroup" placeholder="–ü–ö–®, –ö–Ω–∏–≥–æ—Ç–µ—Ä–∞–ø–∏—è..."></div>
    <div class="form-actions">
      <button class="btn" onclick="closeAll()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveStudent()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- ===== Add Lesson Modal ===== -->
<div class="overlay" id="m-lesson" onclick="if(event.target===this)closeAll()">
  <div class="modal">
    <h3><span>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ</span><button class="modal-x" onclick="closeAll()">&times;</button></h3>
    <div class="form-row"><label>–£—á–µ–Ω–∏–∫</label><select id="f-lstudent"></select></div>
    <div class="form-row"><label>–ü—Ä–µ–¥–º–µ—Ç</label><input id="f-lsubject" placeholder="–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞"></div>
    <div class="form-row"><label>–î–∞—Ç–∞</label><input id="f-ldate" type="date"></div>
    <div class="form-row"><label>–í—Ä–µ–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><input id="f-ltime" type="time"></div>
    <div class="form-actions">
      <button class="btn" onclick="closeAll()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveLesson()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- ===== Recurring Lessons Modal ===== -->
<div class="overlay" id="m-recurring" onclick="if(event.target===this)closeAll()">
  <div class="modal">
    <h3><span>–°–æ–∑–¥–∞—Ç—å –∑–∞–Ω—è—Ç–∏—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</span><button class="modal-x" onclick="closeAll()">&times;</button></h3>
    <div class="form-row"><label>–£—á–µ–Ω–∏–∫</label><select id="f-rstudent"></select></div>
    <div class="form-row"><label>–ü—Ä–µ–¥–º–µ—Ç</label><input id="f-rsubject" placeholder="–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞"></div>
    <div class="form-row"><label>–í—Ä–µ–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><input id="f-rtime" type="time"></div>
    <div class="form-row">
      <label>–î–Ω–∏ –Ω–µ–¥–µ–ª–∏</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="day-1" value="1"><span>–ü–Ω</span></label>
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="day-2" value="2"><span>–í—Ç</span></label>
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="day-3" value="3"><span>–°—Ä</span></label>
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="day-4" value="4"><span>–ß—Ç</span></label>
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="day-5" value="5"><span>–ü—Ç</span></label>
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="day-6" value="6"><span>–°–±</span></label>
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer"><input type="checkbox" id="day-0" value="0"><span>–í—Å</span></label>
      </div>
    </div>
    <div class="form-row"><label>–ù–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞</label><input id="f-rstart" type="date"></div>
    <div class="form-row"><label>–ö–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞</label><input id="f-rend" type="date"></div>
    <div class="form-actions">
      <button class="btn" onclick="closeAll()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveRecurring()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<script>
const MR=['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
const DR=['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
const DF=['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞','–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];

let DATA={students:[],lessons:[],attendance:{}};
let curY,curM,editStudentId=null;
let useServer=false;

const LS_KEY='calendar_data';

// ===== STORAGE =====
async function loadData(){
  // 1. Check localStorage first
  const saved=localStorage.getItem(LS_KEY);
  if(saved){
    try{
      DATA=JSON.parse(saved);
      if(DATA.students&&DATA.students.length>0){
        // Have data in localStorage, use it
        useServer=false;
        return;
      }
    }catch(e){}
  }

  // 2. If no data in localStorage, try to load from data.json (initial data)
  try{
    const r=await fetch('/data.json');
    if(r.ok){
      DATA=await r.json();
      // Save to localStorage for future use
      localStorage.setItem(LS_KEY,JSON.stringify(DATA));
      console.log('Loaded initial data from data.json');
      useServer=false;
      return;
    }
  }catch(e){
    console.log('Could not load data.json:',e);
  }

  // 3. Try API endpoint as last resort
  try{
    const r=await fetch('/api/data');
    if(r.ok){
      DATA=await r.json();
      useServer=true;
      return;
    }
  }catch(e){
    console.log('Could not load from API:',e);
  }

  // 4. Fallback to empty data
  useServer=false;
  if(!DATA.students)DATA.students=[];
  if(!DATA.lessons)DATA.lessons=[];
  if(!DATA.attendance)DATA.attendance={};
}
async function saveData(){
  // Save to localStorage always
  localStorage.setItem(LS_KEY,JSON.stringify(DATA));
  // Also try server if available
  if(useServer){
    try{
      await fetch('/api/data',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(DATA)});
    }catch(e){useServer=false}
  }
}

// ===== INIT =====
(async()=>{
  const n=new Date();curY=n.getFullYear();curM=n.getMonth();
  await loadData();
  render();
})();

function render(){renderCal();renderStudents();renderSchedule();renderAtt();renderStats()}

// ===== VIEWS =====
function showView(v,btn){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  ['calendar','students','schedule','attendance','stats'].forEach(id=>{
    document.getElementById('v-'+id).classList.toggle('hidden',id!==v);
  });
  if(v==='attendance')renderAtt();
  if(v==='stats')renderStats();
}

function closeAll(){document.querySelectorAll('.overlay').forEach(o=>o.classList.remove('open'))}

// ===== CALENDAR =====
function chgMonth(d){curM+=d;if(curM>11){curM=0;curY++}if(curM<0){curM=11;curY--}renderCal()}

function getLessonsForDate(ds){return DATA.lessons.filter(l=>l.date===ds)}

function renderCal(){
  const g=document.getElementById('cal-grid');
  document.getElementById('month-label').textContent=MR[curM]+' '+curY;
  let h='';
  DR.forEach(d=>{h+='<div class="cal-hdr">'+d+'</div>'});
  const fd=new Date(curY,curM,1);let sd=fd.getDay();sd=sd===0?6:sd-1;
  const dim=new Date(curY,curM+1,0).getDate();
  const pdm=new Date(curY,curM,0).getDate();
  const today=new Date().toISOString().slice(0,10);

  for(let i=sd-1;i>=0;i--){
    const day=pdm-i,m=curM===0?11:curM-1,y=curM===0?curY-1:curY;
    h+=mkCell(day,fmtD(y,m,day),true,false);
  }
  for(let day=1;day<=dim;day++){
    const ds=fmtD(curY,curM,day);
    h+=mkCell(day,ds,false,ds===today);
  }
  const tot=sd+dim,rem=(7-tot%7)%7;
  for(let day=1;day<=rem;day++){
    const m=curM===11?0:curM+1,y=curM===11?curY+1:curY;
    h+=mkCell(day,fmtD(y,m,day),true,false);
  }
  g.innerHTML=h;
}

function fmtD(y,m,d){return y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0')}

function mkCell(day,ds,other,isToday){
  const les=getLessonsForDate(ds);
  const cls=['cal-cell'];if(other)cls.push('other');if(isToday)cls.push('today');
  let h='<div class="'+cls.join(' ')+'" onclick="showDay(\''+ds+'\')">';
  h+='<div class="cal-day">'+day+'</div>';
  const mx=3;
  les.slice(0,mx).forEach(l=>{
    const s=getStudent(l.studentId);
    const att=DATA.attendance[l.date+'_'+l.studentId+'_'+l.subject];
    let ac=att===true?'ok':att===false?'no':'';
    h+='<div class="cal-ev ind '+ac+'">'+(s?s.name.split(' ').pop():'')+': '+l.subject+'</div>';
  });
  if(les.length>mx)h+='<div class="cal-more">+' +(les.length-mx)+' –µ—â—ë</div>';
  h+='</div>';return h;
}

function showDay(ds){
  const les=getLessonsForDate(ds);
  if(!les.length)return;
  const d=new Date(ds+'T00:00:00'),dw=d.getDay(),di=dw===0?6:dw-1;
  document.getElementById('m-day-title').textContent=DF[di]+', '+d.getDate()+' '+MR[d.getMonth()].toLowerCase()+' '+d.getFullYear();
  let h='';
  les.forEach(l=>{
    const s=getStudent(l.studentId);
    const key=l.date+'_'+l.studentId+'_'+l.subject;
    const att=DATA.attendance[key];
    h+='<div class="lesson-row">';
    h+='<div style="flex:1"><strong>'+(s?s.name:'?')+'</strong> ‚Äî '+l.subject+(l.time?' ('+l.time+')':'')+'</div>';
    h+='<span class="att-dot '+(att===true?'yes':att===false?'no':'')+'" onclick="toggleAtt(\''+key+'\',this)" title="–ö–ª–∏–∫ = –æ—Ç–º–µ—Ç–∏—Ç—å">'+(att===true?'+':att===false?'-':'?')+'</span>';
    h+='</div>';
  });
  document.getElementById('m-day-body').innerHTML=h;
  document.getElementById('m-day').classList.add('open');
}

async function toggleAtt(key,el){
  const cur=DATA.attendance[key];
  if(cur===true)DATA.attendance[key]=false;
  else if(cur===false)delete DATA.attendance[key];
  else DATA.attendance[key]=true;
  await saveData();
  const v=DATA.attendance[key];
  el.className='att-dot '+(v===true?'yes':v===false?'no':'');
  el.textContent=v===true?'+':v===false?'-':'?';
  renderCal();
}

// ===== STUDENTS =====
function getStudent(id){return DATA.students.find(s=>s.id===id)}
let openCards={};

function renderStudents(){
  const c=document.getElementById('students-list');
  if(!DATA.students.length){c.innerHTML='<div class="empty">–ù–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞".</div>';return}
  let h='';
  DATA.students.forEach(s=>{
    const lesCount=DATA.lessons.filter(l=>l.studentId===s.id).length;
    h+='<div class="card"><div class="card-hdr" onclick="togCard(\'s'+s.id+'\')">';
    h+='<div><div class="student-name">'+s.name+'</div><div class="student-info">'+s.desc+' | –ó–∞–Ω—è—Ç–∏–π: '+lesCount+(s.group?' | –ì—Ä—É–ø–ø–∞: '+s.group:'')+'</div></div>';
    h+='<div style="display:flex;gap:6px"><button class="btn btn-sm" onclick="event.stopPropagation();editStudent(\''+s.id+'\')">–†–µ–¥.</button><button class="btn btn-sm btn-danger" onclick="event.stopPropagation();delStudent(\''+s.id+'\')">X</button></div>';
    h+='</div><div class="card-body'+(openCards['s'+s.id]?' open':'')+'" id="cb-s'+s.id+'">';
    const les=DATA.lessons.filter(l=>l.studentId===s.id).sort((a,b)=>a.date.localeCompare(b.date));
    if(les.length){
      les.forEach(l=>{
        const d=new Date(l.date+'T00:00:00'),dw=d.getDay(),di=dw===0?6:dw-1;
        const key=l.date+'_'+l.studentId+'_'+l.subject;
        const att=DATA.attendance[key];
        h+='<div class="lesson-row"><div style="min-width:100px;color:var(--gray)">'+d.getDate()+'.'+String(d.getMonth()+1).padStart(2,'0')+' '+DR[di]+'</div>';
        h+='<div style="flex:1;font-weight:500">'+l.subject+'</div>';
        h+=(l.time?'<div style="color:var(--gray);font-size:12px">'+l.time+'</div>':'');
        h+='<span class="badge '+(att===true?'badge-ok':att===false?'badge-no':'badge-gray')+'">'+(att===true?'–ø—Ä–∏—à—ë–ª':att===false?'–ø—Ä–æ–ø—É—Å–∫':'‚Äî')+'</span></div>';
      });
    }else h+='<div class="empty">–ó–∞–Ω—è—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>';
    h+='</div></div>';
  });
  c.innerHTML=h;
}

function togCard(id){
  openCards[id]=!openCards[id];
  const el=document.getElementById('cb-'+id);
  if(el)el.classList.toggle('open');
}

function openAddStudent(){
  editStudentId=null;
  document.getElementById('m-student-title').textContent='–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞';
  document.getElementById('f-sname').value='';
  document.getElementById('f-sdesc').value='';
  document.getElementById('f-sgroup').value='';
  document.getElementById('m-student').classList.add('open');
}

function editStudent(id){
  const s=getStudent(id);if(!s)return;
  editStudentId=id;
  document.getElementById('m-student-title').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—á–µ–Ω–∏–∫–∞';
  document.getElementById('f-sname').value=s.name;
  document.getElementById('f-sdesc').value=s.desc;
  document.getElementById('f-sgroup').value=s.group||'';
  document.getElementById('m-student').classList.add('open');
}

async function saveStudent(){
  const name=document.getElementById('f-sname').value.trim();
  if(!name){alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');return}
  const desc=document.getElementById('f-sdesc').value.trim();
  const group=document.getElementById('f-sgroup').value.trim();
  if(editStudentId){
    const s=getStudent(editStudentId);
    if(s){s.name=name;s.desc=desc;s.group=group}
  }else{
    DATA.students.push({id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),name,desc,group});
  }
  await saveData();closeAll();render();
}

async function delStudent(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞ –∏ –≤—Å–µ –µ–≥–æ –∑–∞–Ω—è—Ç–∏—è?'))return;
  DATA.students=DATA.students.filter(s=>s.id!==id);
  DATA.lessons=DATA.lessons.filter(l=>l.studentId!==id);
  // clean attendance
  Object.keys(DATA.attendance).forEach(k=>{if(k.includes('_'+id+'_'))delete DATA.attendance[k]});
  await saveData();render();
}

// ===== SCHEDULE =====
function renderSchedule(){
  const c=document.getElementById('schedule-list');
  if(!DATA.lessons.length){c.innerHTML='<div class="empty">–ù–µ—Ç –∑–∞–Ω—è—Ç–∏–π. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ".</div>';return}
  // group by student
  const byStudent={};
  DATA.lessons.forEach(l=>{
    if(!byStudent[l.studentId])byStudent[l.studentId]=[];
    byStudent[l.studentId].push(l);
  });
  let h='';
  Object.keys(byStudent).forEach(sid=>{
    const s=getStudent(sid);
    const les=byStudent[sid].sort((a,b)=>a.date.localeCompare(b.date));
    h+='<div class="card"><div class="card-hdr" onclick="togCard(\'l'+sid+'\')">';
    h+='<div><div class="student-name">'+(s?s.name:'–£–¥–∞–ª—ë–Ω–Ω—ã–π —É—á–µ–Ω–∏–∫')+'</div><div class="student-info">'+les.length+' –∑–∞–Ω—è—Ç–∏–π</div></div></div>';
    h+='<div class="card-body'+(openCards['l'+sid]?' open':'')+'" id="cb-l'+sid+'">';
    les.forEach(l=>{
      const d=new Date(l.date+'T00:00:00'),dw=d.getDay(),di=dw===0?6:dw-1;
      h+='<div class="lesson-row"><div style="min-width:100px;color:var(--gray)">'+d.getDate()+'.'+String(d.getMonth()+1).padStart(2,'0')+' '+DR[di]+'</div>';
      h+='<div style="flex:1;font-weight:500">'+l.subject+'</div>';
      h+=(l.time?'<div style="color:var(--gray);font-size:12px">'+l.time+'</div>':'');
      h+='<button class="btn btn-sm btn-danger" onclick="delLesson(\''+l.id+'\')">X</button></div>';
    });
    h+='</div></div>';
  });
  c.innerHTML=h;
}

function openAddLesson(){
  if(!DATA.students.length){alert('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —É—á–µ–Ω–∏–∫–∞');return}
  const sel=document.getElementById('f-lstudent');
  sel.innerHTML=DATA.students.map(s=>'<option value="'+s.id+'">'+s.name+'</option>').join('');
  document.getElementById('f-lsubject').value='';
  document.getElementById('f-ldate').value='';
  document.getElementById('f-ltime').value='';
  document.getElementById('m-lesson').classList.add('open');
}

async function saveLesson(){
  const studentId=document.getElementById('f-lstudent').value;
  const subject=document.getElementById('f-lsubject').value.trim();
  const date=document.getElementById('f-ldate').value;
  const time=document.getElementById('f-ltime').value;
  if(!subject||!date){alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏ –¥–∞—Ç—É');return}
  DATA.lessons.push({id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),studentId,subject,date,time});
  await saveData();closeAll();render();
}

async function delLesson(id){
  DATA.lessons=DATA.lessons.filter(l=>l.id!==id);
  await saveData();render();
}

// ===== RECURRING LESSONS =====
function openRecurring(){
  if(!DATA.students.length){alert('–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —É—á–µ–Ω–∏–∫–∞');return}
  const sel=document.getElementById('f-rstudent');
  sel.innerHTML=DATA.students.map(s=>'<option value="'+s.id+'">'+s.name+'</option>').join('');
  document.getElementById('f-rsubject').value='';
  document.getElementById('f-rtime').value='';
  document.getElementById('f-rstart').value='';
  document.getElementById('f-rend').value='';
  [0,1,2,3,4,5,6].forEach(d=>document.getElementById('day-'+d).checked=false);
  document.getElementById('m-recurring').classList.add('open');
}

async function saveRecurring(){
  const studentId=document.getElementById('f-rstudent').value;
  const subject=document.getElementById('f-rsubject').value.trim();
  const time=document.getElementById('f-rtime').value;
  const start=document.getElementById('f-rstart').value;
  const end=document.getElementById('f-rend').value;

  if(!subject||!start||!end){alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');return}

  const days=[];
  [0,1,2,3,4,5,6].forEach(d=>{
    if(document.getElementById('day-'+d).checked)days.push(d);
  });
  if(!days.length){alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏');return}

  // Generate lessons
  const startDate=new Date(start+'T00:00:00');
  const endDate=new Date(end+'T00:00:00');
  let count=0;

  for(let d=new Date(startDate);d<=endDate;d.setDate(d.getDate()+1)){
    const dayOfWeek=d.getDay();
    if(days.includes(dayOfWeek)){
      const ds=d.toISOString().slice(0,10);
      const lid=Date.now().toString(36)+Math.random().toString(36).slice(2,6)+count;
      DATA.lessons.push({id:lid,studentId,subject,date:ds,time});
      count++;
    }
  }

  await saveData();closeAll();render();
  alert(`–°–æ–∑–¥–∞–Ω–æ –∑–∞–Ω—è—Ç–∏–π: ${count}`);
}

// ===== ATTENDANCE VIEW =====
function renderAtt(){
  const c=document.getElementById('att-content');
  if(!DATA.students.length||!DATA.lessons.length){c.innerHTML='<div class="empty">–î–æ–±–∞–≤—å—Ç–µ —É—á–µ–Ω–∏–∫–æ–≤ –∏ –∑–∞–Ω—è—Ç–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</div>';return}

  // Get all unique dates
  const allDates=[...new Set(DATA.lessons.map(l=>l.date))].sort();
  if(!allDates.length){c.innerHTML='<div class="empty">–ù–µ—Ç –∑–∞–Ω—è—Ç–∏–π</div>';return}

  // Group by month
  const byMonth={};
  allDates.forEach(ds=>{
    const key=ds.slice(0,7);
    if(!byMonth[key])byMonth[key]=[];
    byMonth[key].push(ds);
  });

  let h='';
  Object.keys(byMonth).sort().forEach(mk=>{
    const dates=byMonth[mk];
    const [y,m]=mk.split('-').map(Number);
    h+='<div style="margin-bottom:24px"><div class="section-title">'+MR[m-1]+' '+y+'</div>';
    h+='<div class="card"><div class="att-wrap"><table class="att-tbl"><thead><tr><th>–£—á–µ–Ω–∏–∫</th>';
    dates.forEach(ds=>{
      const d=new Date(ds+'T00:00:00');
      h+='<th>'+d.getDate()+'</th>';
    });
    h+='</tr></thead><tbody>';

    DATA.students.forEach(s=>{
      // Check if student has any lessons on these dates
      const hasLessons=dates.some(ds=>DATA.lessons.some(l=>l.studentId===s.id&&l.date===ds));
      if(!hasLessons)return;

      h+='<tr><td>'+s.name+'</td>';
      dates.forEach(ds=>{
        const sLessons=DATA.lessons.filter(l=>l.studentId===s.id&&l.date===ds);
        if(!sLessons.length){h+='<td>‚Äî</td>';return}
        // Summarize: all attended, some, none
        const keys=sLessons.map(l=>l.date+'_'+l.studentId+'_'+l.subject);
        const attended=keys.filter(k=>DATA.attendance[k]===true).length;
        const total=keys.length;
        if(attended===total&&total>0)h+='<td><span class="att-dot yes" title="'+attended+'/'+total+'">+</span></td>';
        else if(attended>0)h+='<td><span class="att-dot" style="background:#fef3c7;color:#92400e" title="'+attended+'/'+total+'">~</span></td>';
        else{
          const absent=keys.filter(k=>DATA.attendance[k]===false).length;
          if(absent>0)h+='<td><span class="att-dot no" title="–æ—Ç–º–µ—á–µ–Ω –ø—Ä–æ–ø—É—Å–∫">-</span></td>';
          else h+='<td><span class="att-dot" title="–Ω–µ –æ—Ç–º–µ—á–µ–Ω–æ">?</span></td>';
        }
      });
      h+='</tr>';
    });
    h+='</tbody></table></div></div></div>';
  });
  c.innerHTML=h;
}

// ===== STATISTICS =====
function renderStats(){
  const c=document.getElementById('stats-content');
  if(!DATA.students.length||!DATA.lessons.length){c.innerHTML='<div class="empty">–î–æ–±–∞–≤—å—Ç–µ —É—á–µ–Ω–∏–∫–æ–≤ –∏ –∑–∞–Ω—è—Ç–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';return}

  // Calculate stats for each student
  const stats=DATA.students.map(s=>{
    const lessons=DATA.lessons.filter(l=>l.studentId===s.id);
    const total=lessons.length;
    const keys=lessons.map(l=>l.date+'_'+l.studentId+'_'+l.subject);
    const attended=keys.filter(k=>DATA.attendance[k]===true).length;
    const absent=keys.filter(k=>DATA.attendance[k]===false).length;
    const unmarked=total-attended-absent;
    const percent=total>0?Math.round((attended/total)*100):0;
    return {student:s,total,attended,absent,unmarked,percent};
  }).filter(st=>st.total>0).sort((a,b)=>a.percent-b.percent);

  if(!stats.length){c.innerHTML='<div class="empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>';return}

  let h='<div class="stat-grid">';
  stats.forEach(st=>{
    const s=st.student;
    const pColor=st.percent>=80?'good':st.percent>=60?'':'bad';
    h+='<div class="stat-card">';
    h+='<div class="stat-name">'+s.name+'</div>';
    if(s.group)h+='<div class="stat-group">–ì—Ä—É–ø–ø–∞: '+s.group+'</div>';
    h+='<div class="percent-big '+pColor+'">'+st.percent+'%</div>';
    h+='<div class="progress-bar"><div class="progress-fill" style="width:'+st.percent+'%"></div></div>';
    h+='<div class="stat-row"><span class="stat-label">–í—Å–µ–≥–æ –∑–∞–Ω—è—Ç–∏–π:</span><span class="stat-value">'+st.total+'</span></div>';
    h+='<div class="stat-row"><span class="stat-label">–ü–æ—Å–µ—â–µ–Ω–æ:</span><span class="stat-value good">'+st.attended+'</span></div>';
    h+='<div class="stat-row"><span class="stat-label">–ü—Ä–æ–ø—É—â–µ–Ω–æ:</span><span class="stat-value bad">'+st.absent+'</span></div>';
    if(st.unmarked>0)h+='<div class="stat-row"><span class="stat-label">–ù–µ –æ—Ç–º–µ—á–µ–Ω–æ:</span><span class="stat-value">'+st.unmarked+'</span></div>';
    h+='</div>';
  });
  h+='</div>';
  c.innerHTML=h;
}

// ===== KEYBOARD =====
document.addEventListener('keydown',e=>{
  if(e.key==='Escape')closeAll();
});
</script>
</body>
</html>
